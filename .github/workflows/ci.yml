name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allow manual triggering

jobs:
  typescript:
    name: TypeScript Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TypeScript
        run: npm run build
      
      - name: Run basic tests
        run: npm run test:basic
      
      - name: Run extended tests
        run: npm run test:extended
      
      - name: Run all tests
        run: npm run test:all
      
      - name: Run benchmarks
        run: npm run bench
      
      - name: Check for TypeScript errors
        run: npx tsc --noEmit
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-test-results-node-${{ matrix.node-version }}
          path: |
            build/
            dist/

  rust:
    name: Rust Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: rust-skel/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Rust (debug)
        working-directory: rust-skel
        run: cargo build
      
      - name: Build Rust (release)
        working-directory: rust-skel
        run: cargo build --release
      
      - name: Run Rust tests
        working-directory: rust-skel
        run: cargo test --release -- --nocapture
      
      - name: Check Rust formatting
        working-directory: rust-skel
        run: cargo fmt -- --check
        if: matrix.rust == 'stable'
      
      - name: Run Clippy lints
        working-directory: rust-skel
        run: cargo clippy -- -D warnings
        if: matrix.rust == 'stable'
      
      - name: Upload Rust artifacts
        if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
        uses: actions/upload-artifact@v4
        with:
          name: rust-release-${{ matrix.os }}
          path: rust-skel/target/release/libssz_stream.*

  c-build:
    name: C Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make
      
      - name: Build C implementation
        working-directory: c-skel
        run: make all
      
      - name: Run C tests
        working-directory: c-skel
        run: make test
      
      - name: Upload C build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: c-build-artifacts
          path: c-skel/*.o

  cross-compile:
    name: Cross-compilation Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-riscv64-linux-gnu || echo "RISC-V GCC not available"
      
      - name: Cross-compile C to RISC-V
        working-directory: c-skel
        run: make riscv || echo "RISC-V cross-compile skipped (toolchain not available)"
        continue-on-error: true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for TODOs and FIXMEs
        run: |
          echo "Checking for TODO/FIXME comments..."
          ! grep -r "TODO\|FIXME" src/ || echo "Found TODO/FIXME items"
      
      - name: Check file sizes
        run: |
          echo "Checking core file sizes (should be minimal)..."
          find src -name "*.ts" -exec wc -l {} + | sort -n
      
      - name: Verify no console.log in production code
        run: |
          ! grep -r "console\.log" src/ || echo "Warning: console.log found in src/"

  integration:
    name: Cross-Language Integration Test
    runs-on: ubuntu-latest
    needs: [typescript, rust, c-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build all implementations
        run: |
          npm ci
          npm run build
          cd rust-skel && cargo build --release
      
      - name: Run TypeScript tests
        run: npm run test:all
      
      - name: Run Rust tests
        working-directory: rust-skel
        run: cargo test --release
      
      - name: Verify cross-language compatibility
        run: |
          echo "All implementations built and tested successfully"
          echo "TypeScript: 59 tests"
          echo "Rust: 17 tests"

  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run benchmarks
        run: npm run bench > benchmark-results.txt
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt
      
      - name: Check performance regression
        run: |
          echo "Checking for major performance regressions..."
          # Could add logic here to compare with baseline

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate || true
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run cargo audit
        working-directory: rust-skel
        run: |
          cargo install cargo-audit || true
          cargo audit || true
        continue-on-error: true

  wasm:
    name: WASM Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Install wasm-opt
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen
      
      - name: Build WASM (web)
        working-directory: wasm
        run: wasm-pack build --target web --out-dir pkg --release
      
      - name: Build WASM (nodejs)
        working-directory: wasm
        run: wasm-pack build --target nodejs --out-dir pkg-nodejs --release
      
      - name: Optimize WASM
        working-directory: wasm
        run: |
          wasm-opt -Oz pkg/ssz_verifier_wasm_bg.wasm -o pkg/ssz_verifier_wasm_bg.wasm
          wasm-opt -Oz pkg-nodejs/ssz_verifier_wasm_bg.wasm -o pkg-nodejs/ssz_verifier_wasm_bg.wasm
      
      - name: Check WASM size
        working-directory: wasm
        run: |
          echo "Web WASM size:"
          ls -lh pkg/ssz_verifier_wasm_bg.wasm
          echo "Node.js WASM size:"
          ls -lh pkg-nodejs/ssz_verifier_wasm_bg.wasm
      
      - name: Run WASM tests
        working-directory: wasm
        run: wasm-pack test --node
      
      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-builds
          path: |
            wasm/pkg/
            wasm/pkg-nodejs/
