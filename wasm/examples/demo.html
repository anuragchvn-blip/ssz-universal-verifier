<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSZ Verifier WASM Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .input-group {
            margin: 20px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .output {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        .success {
            border-color: #4CAF50;
            background: #f1f8f4;
        }
        .error {
            border-color: #f44336;
            background: #fef1f1;
            color: #c62828;
        }
        .info {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .examples {
            margin-top: 20px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 4px;
        }
        .examples h3 {
            margin-top: 0;
        }
        .example-btn {
            background: #2196F3;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }
        .example-btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê SSZ Universal Verifier WASM Demo</h1>
        
        <div class="info">
            <strong>About:</strong> This demo uses WebAssembly to compute SSZ merkle roots 
            directly in your browser. No server-side processing!
        </div>

        <div id="loading" class="loading">
            <p>‚è≥ Loading WASM module...</p>
        </div>

        <div id="app" style="display: none;">
            <div class="input-group">
                <label for="typeSelect">SSZ Type:</label>
                <select id="typeSelect">
                    <option value="uint64">uint64 (8 bytes)</option>
                    <option value="uint32">uint32 (4 bytes)</option>
                    <option value="bytes32">bytes32 (32 bytes)</option>
                    <option value="bitlist">bitlist (variable, with delimiter)</option>
                    <option value="list">list (variable length)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="dataInput">Input Data (hex, without 0x prefix):</label>
                <textarea id="dataInput" rows="3" placeholder="e.g., 2a00000000000000 for uint64(42)">2a00000000000000</textarea>
            </div>

            <div class="input-group" id="typeDescGroup" style="display: none;">
                <label for="typeDescInput">Type Descriptor (JSON):</label>
                <textarea id="typeDescInput" rows="4" placeholder='{"type": "list", "elementType": {"type": "uint64"}, "length": 100}'></textarea>
            </div>

            <button id="computeBtn">üîç Compute Root</button>

            <div class="examples">
                <h3>Quick Examples:</h3>
                <button class="example-btn" onclick="loadExample('uint64')">uint64(42)</button>
                <button class="example-btn" onclick="loadExample('bytes32')">bytes32</button>
                <button class="example-btn" onclick="loadExample('bitlist')">bitlist (4 bits)</button>
                <button class="example-btn" onclick="loadExample('empty')">Empty list</button>
            </div>

            <div id="output"></div>
        </div>
    </div>

    <script type="module">
        import init, { sszStreamRoot, getVersion } from '../pkg/ssz_verifier_wasm.js';

        let wasmReady = false;

        async function initWasm() {
            try {
                await init();
                wasmReady = true;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                console.log('‚úÖ WASM module loaded, version:', getVersion());
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    `<p class="error">‚ùå Failed to load WASM: ${error.message}</p>`;
            }
        }

        function hexToBytes(hex) {
            hex = hex.replace(/\s/g, '');
            if (hex.length % 2 !== 0) {
                throw new Error('Hex string must have even length');
            }
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function computeRoot() {
            if (!wasmReady) {
                showOutput('WASM not ready yet', 'error');
                return;
            }

            try {
                const typeSelect = document.getElementById('typeSelect').value;
                const dataInput = document.getElementById('dataInput').value.trim();
                
                const data = hexToBytes(dataInput);
                
                // Build type descriptor
                let typeDesc;
                if (typeSelect === 'list') {
                    const typeDescInput = document.getElementById('typeDescInput').value;
                    typeDesc = typeDescInput || JSON.stringify({
                        type: 'list',
                        elementType: { type: 'uint64' },
                        length: 100
                    });
                } else if (typeSelect === 'bitlist') {
                    typeDesc = JSON.stringify({ type: 'bitlist', length: 256 });
                } else {
                    typeDesc = JSON.stringify({ type: typeSelect });
                }
                
                console.log('Computing root with type:', typeDesc);
                console.log('Data:', dataInput);
                
                const root = sszStreamRoot(data, typeDesc);
                const rootHex = bytesToHex(root);
                
                showOutput(`
                    <strong>‚úÖ Success!</strong><br><br>
                    <strong>Root:</strong><br>
                    0x${rootHex}<br><br>
                    <strong>Data Length:</strong> ${data.length} bytes<br>
                    <strong>Type:</strong> ${typeSelect}
                `, 'success');
                
            } catch (error) {
                showOutput(`<strong>‚ùå Error:</strong><br>${error.message}`, 'error');
            }
        }

        function showOutput(html, type) {
            const output = document.getElementById('output');
            output.innerHTML = html;
            output.className = `output ${type}`;
        }

        // Event listeners
        document.getElementById('computeBtn').addEventListener('click', computeRoot);
        
        document.getElementById('typeSelect').addEventListener('change', (e) => {
            const typeDescGroup = document.getElementById('typeDescGroup');
            if (e.target.value === 'list') {
                typeDescGroup.style.display = 'block';
            } else {
                typeDescGroup.style.display = 'none';
            }
        });

        // Global function for examples
        window.loadExample = function(type) {
            const dataInput = document.getElementById('dataInput');
            const typeSelect = document.getElementById('typeSelect');
            
            switch(type) {
                case 'uint64':
                    typeSelect.value = 'uint64';
                    dataInput.value = '2a00000000000000'; // 42
                    break;
                case 'bytes32':
                    typeSelect.value = 'bytes32';
                    dataInput.value = '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef';
                    break;
                case 'bitlist':
                    typeSelect.value = 'bitlist';
                    dataInput.value = '0f'; // 4 bits set + delimiter
                    break;
                case 'empty':
                    typeSelect.value = 'list';
                    dataInput.value = '';
                    document.getElementById('typeDescInput').value = JSON.stringify({
                        type: 'list',
                        elementType: { type: 'uint64' },
                        length: 100
                    });
                    break;
            }
            
            document.getElementById('typeSelect').dispatchEvent(new Event('change'));
        };

        // Initialize
        initWasm();
    </script>
</body>
</html>
